name: CD - Build and Release

on:
  workflow_run:
    workflows: ["CI - Pylint"]
    types:
      - completed
    branches:
      - '**'

permissions:
  contents: write

jobs:
  # Build job runs on all branches to catch errors early
  build:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path python/requirements.txt) {
            pip install -r python/requirements.txt
          }
      
      - name: Save certificate files
        env:
          CERT_PEM: ${{ secrets.CERT_PEM }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}
          CERT_POLICY: ${{ secrets.CERT_POLICY }}
          ROOT_CA: ${{ secrets.ROOT_CA }}
        run: |
          New-Item -ItemType Directory -Force -Path python/certificates
          $env:CERT_PEM | Out-File -FilePath python/certificates/pit_stop_manager.cert.pem -Encoding utf8
          $env:PRIVATE_KEY | Out-File -FilePath python/certificates/pit_stop_manager.private.key -Encoding utf8
          $env:PUBLIC_KEY | Out-File -FilePath python/certificates/pit_stop_manager.public.key -Encoding utf8
          $env:CERT_POLICY | Out-File -FilePath python/certificates/pit_stop_manager-Policy -Encoding utf8
          $env:ROOT_CA | Out-File -FilePath python/certificates/root-CA.crt -Encoding utf8

      - name: Create .env file
        run: |
          @"
          IDENTITY_POOL_ID=${{ secrets.IDENTITY_POOL_ID }}
          CREATE_LOBBY_URL=${{ secrets.CREATE_LOBBY_URL }}
          IOT_TOPIC_URL=${{ secrets.IOT_TOPIC_URL }}
          LOBBY_AUTH_URL=${{ secrets.LOBBY_AUTH_URL }}
          UUID_EDIT_URL=${{ secrets.UUID_EDIT_URL }}
          WEBSITE_URL=${{ vars.WEBSITE_URL }}
          "@ | Out-File -FilePath python/.env -Encoding utf8

      - name: Build with PyInstaller
        working-directory: python
        run: |
          pyinstaller iRemoteEngineer.spec

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iRemoteEngineer-exe
          path: python/dist/iRemoteEngineer.exe
          retention-days: 1

  # Release job only runs on main branch after successful build
  release:
    runs-on: windows-latest
    needs: build
    if: ${{ github.event.workflow_run.head_branch == 'main' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read version
        id: read_version
        run: |
          $currentVersion = (Get-Content "python/VERSION" -Raw).Trim()
          Write-Host "Current version: $currentVersion"
          echo "version=$currentVersion" >> $env:GITHUB_OUTPUT
          echo "tag_name=v$currentVersion" >> $env:GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        run: |
          $tag = "${{ steps.read_version.outputs.tag_name }}"
          $exists = git tag -l $tag
          if ($exists) {
            Write-Host "Release $tag already exists, skipping"
            echo "exists=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Release $tag does not exist, will create"
            echo "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Download build artifact
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          name: iRemoteEngineer-exe
          path: python/dist

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.read_version.outputs.tag_name }}
          name: Release ${{ steps.read_version.outputs.version }}
          body: |
            ## iRemoteEngineer ${{ steps.read_version.outputs.version }}

            Automated release from commit ${{ github.event.workflow_run.head_sha }}
          files: |
            python/dist/iRemoteEngineer.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
