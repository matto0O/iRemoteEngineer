name: CD - Build and Release

on:
  workflow_run:
    workflows: ["CI - Pylint"]
    types:
      - completed
    branches:
      - '**'

permissions:
  contents: write

jobs:
  # Build job runs on all branches to catch errors early
  build:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path python/requirements.txt) {
            pip install -r python/requirements.txt
          }
      
      - name: Create certificates directory
        env:
            CERT_PEM: ${{ secrets.CERT_PEM }}
            PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
            PUBLIC_KEY: ${{ secrets.PUBLIC_KEY }}
            CERT_POLICY: ${{ secrets.CERT_POLICY }}
            ROOT_CA: ${{ secrets.ROOT_CA }}
        run: |
            New-Item -ItemType Directory -Force -Path python/certificates
            [IO.File]::WriteAllBytes("python/certificates/pit_stop_manager.cert.pem", [Convert]::FromBase64String($env:CERT_PEM.Trim()))
            [IO.File]::WriteAllBytes("python/certificates/pit_stop_manager.private.key", [Convert]::FromBase64String($env:PRIVATE_KEY.Trim()))
            [IO.File]::WriteAllBytes("python/certificates/pit_stop_manager.public.key", [Convert]::FromBase64String($env:PUBLIC_KEY.Trim()))
            [IO.File]::WriteAllBytes("python/certificates/pit_stop_manager-Policy", [Convert]::FromBase64String($env:CERT_POLICY.Trim()))
            [IO.File]::WriteAllBytes("python/certificates/root-CA.crt", [Convert]::FromBase64String($env:ROOT_CA.Trim()))

      - name: Create .env file
        run: |
          @"
          IDENTITY_POOL_ID=${{ secrets.IDENTITY_POOL_ID }}
          CREATE_LOBBY_URL=${{ secrets.CREATE_LOBBY_URL }}
          IOT_TOPIC_URL=${{ secrets.IOT_TOPIC_URL }}
          LOBBY_AUTH_URL=${{ secrets.LOBBY_AUTH_URL }}
          UUID_EDIT_URL=${{ secrets.UUID_EDIT_URL }}
          WEBSITE_URL=${{ vars.WEBSITE_URL }}
          "@ | Out-File -FilePath python/.env -Encoding utf8

      - name: Build with PyInstaller
        working-directory: python
        run: |
          pyinstaller iRemoteEngineer.spec

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iRemoteEngineer-exe
          path: python/dist/iRemoteEngineer.exe
          retention-days: 1

  # Release job only runs on main branch after successful build
  release:
    runs-on: windows-latest
    needs: build
    if: ${{ github.event.workflow_run.head_branch == 'main' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: iRemoteEngineer-exe
          path: python/dist

      - name: Determine version bump type
        id: version_type
        run: |
          $eventName = "${{ github.event.workflow_run.event }}"
          Write-Host "Event name: $eventName"

          # If the workflow was triggered by a PR event, bump minor version
          # Otherwise (regular push), bump patch version
          if ($eventName -eq "pull_request") {
            echo "bump_type=minor" >> $env:GITHUB_OUTPUT
          } else {
            echo "bump_type=patch" >> $env:GITHUB_OUTPUT
          }

      - name: Bump version
        id: bump_version
        run: |
          # Read current version
          $versionFile = "VERSION"
          $currentVersion = Get-Content $versionFile -Raw
          $currentVersion = $currentVersion.Trim()

          Write-Host "Current version: $currentVersion"

          # Parse version components
          $versionParts = $currentVersion -split '\.'
          $major = [int]$versionParts[0]
          $minor = [int]$versionParts[1]
          $patch = [int]$versionParts[2]

          # Bump based on type
          $bumpType = "${{ steps.version_type.outputs.bump_type }}"

          if ($bumpType -eq "minor") {
            $minor++
            $patch = 0
            Write-Host "Bumping minor version (PR merge)"
          } else {
            $patch++
            Write-Host "Bumping patch version (commit)"
          }

          $newVersion = "$major.$minor.$patch"
          Write-Host "New version: $newVersion"

          # Write new version to file
          $newVersion | Set-Content $versionFile -NoNewline

          # Output for later steps
          echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "tag_name=v$newVersion" >> $env:GITHUB_OUTPUT

      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add VERSION
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]" || echo "No changes to commit"
          git push

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump_version.outputs.tag_name }}
          name: Release ${{ steps.bump_version.outputs.new_version }}
          body: |
            ## iRemoteEngineer ${{ steps.bump_version.outputs.new_version }}

            Automated release from commit ${{ github.event.workflow_run.head_sha }}

            ### Changes
            - Built from branch: ${{ github.event.workflow_run.head_branch }}
            - Trigger: ${{ github.event.workflow_run.event }}
          files: |
            python/dist/iRemoteEngineer.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
